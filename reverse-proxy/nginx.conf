# Nginx reverse proxy to expose only public chat and static assets
# Blocks admin/settings routes while proxying others to OpenWebUI backend

worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Rate limiting zones for public mode (relaxed)
    limit_req_zone $binary_remote_addr zone=chat_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=600r/m;

    # WebSocket support
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # Docker embedded DNS resolver; defer DNS to runtime with variables
    resolver 127.0.0.11 ipv6=off valid=30s;

    server {
        set $up_openwebui openwebui:8080;
        set $up_frontend chatbot-frontend:3000;
        set $up_llm_agent llm-agent:8001;
        listen 8080;
        server_name _;


        # --- ALLOW LIST (public mode에서 필요한 최소 API) ---
        # Config & public settings (초기 부팅에 필요)
        location = /api/config {
            proxy_pass http://$up_openwebui;
            include /etc/nginx/proxy_params;
        }

        location = /api/settings/public {
            proxy_pass http://$up_openwebui;
            include /etc/nginx/proxy_params;
        }

        # Auth API - allow basic auth endpoints only
        location ~* ^/api/v1/auths/?$ {
            proxy_pass http://$up_openwebui;
            include /etc/nginx/proxy_params;
        }

        # 모델 리스트(프론트가 종종 호출) – 강제 고정 응답 유지
        location = /api/models {
            default_type application/json;
            return 200 '{"data":[{"id":"ai-mentor","name":"AI Mentor","object":"model","created":1672531200,"owned_by":"ai-mentor","openai":{"id":"ai-mentor"},"urlIdx":0}]}';
        }

        location = /api/models/base {
            default_type application/json;
            return 200 '{"data":[{"id":"ai-mentor","name":"AI Mentor","object":"model","created":1672531200,"owned_by":"ai-mentor","openai":{"id":"ai-mentor"},"urlIdx":0}]}';
        }

        # --- DENY LIST (관리/민감 기능 차단) ---
        # UI 라우트 차단
        location ~* ^/(?:admin|users|groups|pipelines|openai|evaluations|playground|profile|workspaces?|config|system|store|organizations?|releases|settings|models|auth|login|signup)(?:/|$) {
            return 404;
        }

        # Allow necessary API endpoints for OpenWebUI functionality
        location ~* ^/api/v1/(chats|users|tools|functions|version)(?:/|$) {
            proxy_pass http://$up_openwebui;
            include /etc/nginx/proxy_params;
        }

        location ~* ^/api/(version|ollama)(?:/|$) {
            proxy_pass http://$up_openwebui;
            include /etc/nginx/proxy_params;
        }

        # API 차단 (관리/설정/스토어/지식 등) - 필요한 것들 제외
        location ~* ^/api/(?:admin|settings(?!/public$)|knowledge|prompts|pipelines|store|configs)(?:/|$) {
            return 403;
        }

        # Note: Do not block /api/* so the SPA can initialize
        # (OpenWebUI fetches config/settings on load). We rely on UI hiding instead.

        # API specific routes to backend services (for /ui frontend) - 최우선
        # 슬래시 있는 경로들
        location ^~ /api/llm/ {
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 스트리밍 설정 추가
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_set_header Cache-Control 'no-cache';
            # 장시간 스트리밍 타임아웃 및 버퍼링/압축 비활성화
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 60s;
            proxy_set_header Accept-Encoding '';
            add_header X-Accel-Buffering no;
            gzip off;

            proxy_pass http://$up_llm_agent/;
        }
        location ^~ /api/curriculum/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7996:7996/;
        }
        location ^~ /api/search/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7997:7997/;
        }
        location ^~ /api/sql/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7999:7999/;
        }
        location ^~ /api/fallback/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7998:7998/;
        }
        location ^~ /api/department/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://department-mapping:8000/;
        }
        
        # 슬래시 없는 경로들 (^~로 정규식보다 우선)
        location ^~ /api/llm {
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 스트리밍 설정 추가
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_set_header Cache-Control 'no-cache';
            # 장시간 스트리밍 타임아웃 및 버퍼링/압축 비활성화
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 60s;
            proxy_set_header Accept-Encoding '';
            add_header X-Accel-Buffering no;
            gzip off;

            proxy_pass http://$up_llm_agent;
        }
        location ^~ /api/curriculum {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7996:7996;
        }
        location ^~ /api/search {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7997:7997;
        }
        location ^~ /api/sql {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7999:7999;
        }
        location ^~ /api/fallback {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://svc7998:7998;
        }
        location ^~ /api/department {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://department-mapping:8000;
        }

        # (프론트 개발 서버 경로 제거) OpenWebUI 단일 앱 사용
        # /ui 및 /assets 경로는 OpenWebUI로 전달
        location = /ui {
            return 302 /;
        }
        location /ui/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui/;
        }

        # Frontend static assets (OpenWebUI 빌드 산출물)
        location /assets/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui/;
        }

        # Static files routing
        # 우선순위 오버라이드: 커스텀 CSS/JS를 직접 제공해 가시성 보장
        location = /static/custom.css {
            default_type text/css;
            alias /etc/nginx/custom.css;
        }
        # loader.js는 실제 파일로 프록시
        location = /static/loader.js {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui/static/loader.js;
            proxy_cache_bypass 1;
        }

        # TipTap 경고 억제 JavaScript
        location = /static/suppress-warnings.js {
            default_type application/javascript;
            alias /etc/nginx/suppress-warnings.js;
        }

        # AI Mentor UI Cleanup JavaScript
        location = /static/ai-mentor-cleanup.js {
            default_type application/javascript;
            alias /etc/nginx/ai-mentor-cleanup.js;
            add_header Cache-Control "no-cache, must-revalidate";
        }
        location /static/ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui/static/;
            proxy_cache_bypass 1;
            # 정적 파일 캐시 설정
            expires 1h;
            add_header Cache-Control "public, immutable";
        }

        # SvelteKit _app files - 최고 우선순위로 처리
        location ^~ /_app/ {
            proxy_pass http://$up_openwebui;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Allow static assets to load (but not for /ui paths - those go to Vite)
        location ~* ^(?!/ui/)\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|map)$ {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui;
            expires 1h;
            add_header Cache-Control "public, immutable";
        }

        # location /api/llm-client/ {
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        #     proxy_pass http://llm-client-agent:8002/;
        # }

        # Streaming agent API - route to llm-agent (highest priority)
        location = /api/v2/agent-stream {
            # Rate limiting for streaming API (10 requests per second)
            limit_req zone=chat_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 스트리밍 설정
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_set_header Cache-Control 'no-cache';
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 60s;
            proxy_set_header Accept-Encoding '';
            add_header X-Accel-Buffering no;
            gzip off;

            proxy_pass http://$up_llm_agent/api/v2/agent-stream;
        }

        # OpenAI-compatible chat completions API - route to llm-agent with relaxed rate limiting
        location /api/chat/completions {
            # Rate limiting for chat API (10 requests per second)
            limit_req zone=chat_limit burst=20 nodelay;
            limit_req_status 429;

            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 스트리밍 설정 추가
            proxy_buffering off;
            proxy_cache off;
            proxy_set_header Connection '';
            proxy_set_header Cache-Control 'no-cache';
            # 장시간 스트리밍 타임아웃 및 버퍼링/압축 비활성화
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            proxy_connect_timeout 10s;
            proxy_next_upstream error timeout;
            proxy_next_upstream_tries 3;
            proxy_set_header Accept-Encoding '';
            add_header X-Accel-Buffering no;
            gzip off;

            proxy_pass http://$up_llm_agent/api/v2/agent;
        }

        # 나머지 일반 API는 OpenWebUI로 전달 (완화된 레이트리밋)
        location /api/ {
            # Skip if this is the streaming endpoint
            if ($request_uri ~ "^/api/v2/agent-stream") {
                return 404;
            }
            limit_req zone=api_limit burst=50 nodelay;
            limit_req_status 429;
            proxy_pass http://$up_openwebui;
            include /etc/nginx/proxy_params;
        }

        # WebSocket (채팅 스트리밍) - 개선된 설정
        location /ws/ {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            proxy_pass http://$up_openwebui;
        }
        location /socket.io/ {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            proxy_pass http://$up_openwebui;
        }
        # WebSocket 루트 경로도 추가
        location ~ ^/(ws|socket\.io) {
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 86400s;
            proxy_send_timeout 86400s;
            proxy_pass http://$up_openwebui;
        }

        # Explicit chat route (OpenWebUI API/UI)
        location /chat {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui;
        }

        # (moved /ui handlers above to take precedence)

        # Default - serve OpenWebUI at root with CSS/JS injection
        location / {
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://$up_openwebui;

            # HTML에 CSS와 JavaScript 주입
            sub_filter_once off;
            sub_filter_types text/html;

            # CSS 주입 (head 태그 끝에)
            sub_filter '</head>' '
                <link rel="stylesheet" href="/static/custom.css">
                <script src="/static/ai-mentor-cleanup.js"></script>
            </head>';

            # gzip 압축 비활성화 (sub_filter가 작동하도록)
            proxy_set_header Accept-Encoding "";
        }
    }
}
